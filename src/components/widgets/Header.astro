---
import { Icon } from 'astro-icon/components';
import Logo from '~/components/Logo.astro';
import ToggleTheme from '~/components/common/ToggleTheme.astro';
import ToggleMenu from '~/components/common/ToggleMenu.astro';
import Button from '~/components/ui/Button.astro';

import { getHomePermalink } from '~/utils/permalinks';
import { trimSlash, getAsset } from '~/utils/permalinks';
import type { CallToAction } from '~/types';

interface Link {
  text?: string;
  href?: string;
  ariaLabel?: string;
  icon?: string;
}

interface MenuLink extends Link {
  links?: Array<MenuLink>;
}

export interface Props {
  id?: string;
  links?: Array<MenuLink>;
  actions?: Array<CallToAction>;
  isSticky?: boolean;
  isDark?: boolean;
  isFullWidth?: boolean;
  showToggleTheme?: boolean;
  showRssFeed?: boolean;
  position?: string;
}

const {
  id = 'header',
  links = [],
  actions = [],
  isSticky = false,
  isDark = false,
  isFullWidth = false,
  showToggleTheme = false,
  showRssFeed = false,
  position = 'center',
} = Astro.props;

const currentPath = `/${trimSlash(new URL(Astro.url).pathname)}`;
---

<header
  class:list={[
    { sticky: isSticky, relative: !isSticky, dark: isDark },
    'top-0 z-40 flex-none mx-auto w-full transition-[opacity] ease-in-out',
  ]}
  {...isSticky ? { 'data-aw-sticky-header': true } : {}}
  {...id ? { id } : {}}
>
  <div
    class:list={[
      'relative text-default py-3 px-3 md:px-6 mx-auto w-full',
      {
        'md:flex md:justify-between': position !== 'center',
      },
      {
        'md:grid md:grid-cols-3 md:items-center': position === 'center',
      },
      {
        'max-w-7xl': !isFullWidth,
      },
    ]}
  >
    <div class:list={[{ 'mr-auto rtl:mr-0 rtl:ml-auto': position === 'right' }, 'flex justify-between']}>
      <a class="flex items-center" href={getHomePermalink()}>
        <Logo />
      </a>
      <div class="flex items-center gap-2 md:hidden">
        {showToggleTheme && <ToggleTheme iconClass="w-6 h-6" />}
        <ToggleMenu />
      </div>
    </div>
    <nav
      class="mobile-menu items-center w-full md:w-auto hidden md:flex md:mx-5 text-default overflow-y-auto overflow-x-hidden md:overflow-y-visible md:overflow-x-auto md:justify-self-center"
      aria-label="Main navigation"
      data-mobile-menu
    >
      <ul
        class="mobile-menu-items flex flex-col md:flex-row md:self-center w-full md:w-auto text-xl md:text-[0.9375rem] tracking-[0.01rem] font-medium md:justify-center"
      >
        {
          links.map(({ text, href, links }, index) => (
            <li class={`menu-item ${links?.length ? 'dropdown' : ''} ${href === currentPath ? 'active' : ''}`} style={`animation-delay: ${(index + 1) * 0.1}s`}>
              {links?.length ? (
                <>
                  <button
                    type="button"
                    class="menu-link hover:text-link dark:hover:text-white px-4 py-3 flex items-center whitespace-nowrap"
                  >
                    {text}{' '}
                    <Icon name="tabler:chevron-down" class="w-3.5 h-3.5 ml-0.5 rtl:ml-0 rtl:mr-0.5 hidden md:inline" />
                  </button>
                  <ul class="dropdown-menu md:backdrop-blur-md dark:md:bg-dark rounded md:absolute pl-4 md:pl-0 md:hidden font-medium md:bg-white/90 md:min-w-[200px] drop-shadow-xl">
                    {links.map(({ text: text2, href: href2 }) => (
                      <li>
                        <a
                          class:list={[
                            'first:rounded-t last:rounded-b md:hover:bg-gray-100 hover:text-link dark:hover:text-white dark:hover:bg-gray-700 py-2 px-5 block whitespace-no-wrap',
                            { 'aw-link-active': href2 === currentPath },
                          ]}
                          href={href2}
                        >
                          {text2}
                        </a>
                      </li>
                    ))}
                  </ul>
                </>
              ) : (
                <a
                  class:list={[
                    'menu-link hover:text-link dark:hover:text-white px-4 py-3 flex items-center whitespace-nowrap',
                    { 'aw-link-active': href === currentPath },
                  ]}
                  href={href}
                >
                  {text}
                </a>
              )}
            </li>
          ))
        }
      </ul>
    </nav>
    <div
      class:list={[
        { 'ml-auto rtl:ml-0 rtl:mr-auto': position === 'left' },
        'hidden md:self-center md:flex items-center md:mb-0 fixed w-full md:w-auto md:static justify-end left-0 rtl:left-auto rtl:right-0 bottom-0 p-3 md:p-0 md:justify-self-end',
      ]}
    >
      <div class="items-center flex justify-between w-full md:w-auto">
        <div class="flex">
          {showToggleTheme && <ToggleTheme iconClass="w-6 h-6 md:w-5 md:h-5 md:inline-block" />}
          {
            showRssFeed && (
              <a
                class="text-muted dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center"
                aria-label="RSS Feed"
                href={getAsset('/rss.xml')}
              >
                <Icon name="tabler:rss" class="w-5 h-5" />
              </a>
            )
          }
        </div>
        {
          actions?.length ? (
            <span class="ml-4 rtl:ml-0 rtl:mr-4">
              {actions.map((btnProps) => (
                <Button {...btnProps} class="ml-2 py-2.5 px-5.5 md:px-6 font-semibold shadow-none text-sm w-auto" />
              ))}
            </span>
          ) : (
            ''
          )
        }
      </div>
    </div>
  </div>
</header>

<style>
  /* ========================================
     STOR CONNECT - Mobile Menu Styles
     Modern animated mobile menu
     ======================================== */

  /* Mobile Menu Base - Hidden by default on mobile */
  @media (max-width: 767px) {
    .mobile-menu {
      position: fixed;
      top: 0;
      right: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(54, 69, 79, 0.98);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 50;
      padding: 5rem 2rem 2rem;
      overflow-y: auto;
      display: flex !important;
      flex-direction: column;
      justify-content: flex-start;
    }

    /* Fallback for browsers without backdrop-filter */
    @supports not (backdrop-filter: blur(10px)) {
      .mobile-menu {
        background: rgb(54, 69, 79);
      }
    }

    /* Menu Open State */
    .mobile-menu:not(.hidden) {
      transform: translateX(0);
    }

    /* Menu Items Container */
    .mobile-menu-items {
      width: 100%;
      gap: 0.5rem;
    }

    /* Individual Menu Items */
    .mobile-menu .menu-item {
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      padding: 0;
      margin: 0;
      min-height: 48px; /* Touch target */
    }

    .mobile-menu .menu-item a,
    .mobile-menu .menu-item button {
      font-size: 1.25rem; /* 20px */
      font-weight: 500;
      padding: 1rem 1.5rem;
      color: white;
      width: 100%;
      text-align: left;
      border-left: 4px solid transparent;
      transition: all 0.2s ease;
    }

    /* Active State - Red Border */
    .mobile-menu .menu-item.active a,
    .mobile-menu .menu-item.active button {
      border-left-color: #E01D22;
      background: rgba(224, 29, 34, 0.1);
      color: white;
    }

    /* Hover State */
    .mobile-menu .menu-item a:hover,
    .mobile-menu .menu-item button:hover {
      border-left-color: #E01D22;
      background: rgba(255, 255, 255, 0.05);
    }

    /* Sub-menu Items */
    .mobile-menu .dropdown-menu {
      display: flex !important;
      flex-direction: column;
      padding-left: 2rem;
      margin-top: 0.5rem;
      gap: 0.25rem;
    }

    .mobile-menu .dropdown-menu li {
      opacity: 0;
      animation: fadeInUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .mobile-menu .dropdown-menu li:nth-child(1) { animation-delay: 0.5s; }
    .mobile-menu .dropdown-menu li:nth-child(2) { animation-delay: 0.6s; }
    .mobile-menu .dropdown-menu li:nth-child(3) { animation-delay: 0.7s; }
    .mobile-menu .dropdown-menu li:nth-child(4) { animation-delay: 0.8s; }

    .mobile-menu .dropdown-menu a {
      font-size: 1rem; /* 16px */
      font-weight: 400;
      padding: 0.75rem 1rem;
      color: rgba(255, 255, 255, 0.8);
      border-left: 3px solid transparent;
    }

    .mobile-menu .dropdown-menu a:hover {
      color: white;
      border-left-color: #E01D22;
    }

    /* Dropdown is always open on mobile menu */
    .mobile-menu .dropdown .dropdown-menu {
      display: flex !important;
    }

    /* Safe Area for iPhone Notch */
    .mobile-menu {
      padding-top: max(5rem, env(safe-area-inset-top) + 3rem);
      padding-bottom: max(2rem, env(safe-area-inset-bottom) + 1rem);
      padding-left: max(2rem, env(safe-area-inset-left) + 1rem);
      padding-right: max(2rem, env(safe-area-inset-right) + 1rem);
    }
  }

  /* Fade In Up Animation */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Desktop - Reset Mobile Styles */
  @media (min-width: 768px) {
    .mobile-menu {
      position: static !important;
      transform: none !important;
      background: transparent !important;
      backdrop-filter: none !important;
      width: auto !important;
      height: auto !important;
      padding: 0 !important;
      overflow: visible !important;
      z-index: auto !important;
    }

    .mobile-menu .menu-item {
      opacity: 1 !important;
      transform: none !important;
      animation: none !important;
      min-height: auto !important;
    }

    .mobile-menu .menu-item a,
    .mobile-menu .menu-item button {
      font-size: inherit !important;
      font-weight: inherit !important;
      padding: 0.75rem 1rem !important;
      color: inherit !important;
      width: auto !important;
      border-left: none !important;
      background: transparent !important;
    }

    /* CRITICAL: Reset dropdown f√ºr Desktop - entferne !important damit :hover funktioniert */
    .mobile-menu .dropdown-menu {
      padding-left: 0;
      /* display wird von tailwind.css .dropdown:hover gesteuert */
    }
  }

  /* ========================================
     Logo & Men√º: Dynamisch basierend auf Scroll
     STANDARD = WEISS, Switch mit .scroll Klasse (BasicScripts)
     ======================================== */
  
  /* STANDARD: Logo wei√ü ist sichtbar, Logo dunkel hidden */
  .logo-dark { 
    display: none;
  }
  .logo-light { 
    display: block;
  }

  /* STANDARD: Men√º & Icons wei√ü auf Hero */
  #header .menu-link {
    color: white !important;
  }

  /* STANDARD: Toggle Theme Icon wei√ü auf Hero */
  #header [data-aw-toggle-color-scheme] {
    color: white !important;
  }
  #header [data-aw-toggle-color-scheme] svg {
    color: white !important;
  }

  /* LIGHT MODE + GESCROLLT (.scroll Klasse von BasicScripts): Logo dunkel, Men√º dunkel, Icons dunkel */
  html:not(.dark) #header.scroll .logo-dark { 
    display: block !important;
  }
  html:not(.dark) #header.scroll .logo-light { 
    display: none !important;
  }
  html:not(.dark) #header.scroll .menu-link {
    color: var(--aw-color-text-default) !important;
  }
  html:not(.dark) #header.scroll [data-aw-toggle-color-scheme] {
    color: var(--aw-color-text-default) !important;
  }
  html:not(.dark) #header.scroll [data-aw-toggle-color-scheme] svg {
    color: var(--aw-color-text-default) !important;
  }

  /* DARK MODE: Logo, Men√º & Icons bleiben IMMER wei√ü */
  html.dark .logo-dark { 
    display: none;
  }
  html.dark .logo-light { 
    display: block;
  }
  html.dark .menu-link {
    color: white;
  }
  html.dark [data-aw-toggle-color-scheme] {
    color: white !important;
  }
  html.dark [data-aw-toggle-color-scheme] svg {
    color: white !important;
  }

  /* Transitions */
  .logo-image {
    transition: opacity 0.2s ease;
  }
  .menu-link {
    transition: color 0.2s ease;
  }
</style>

<script>
  // #region agent log
  document.addEventListener('DOMContentLoaded', () => {
    const header = document.querySelector('#header');
    const menuLinks = document.querySelectorAll('.menu-link');
    const toggleIcon = document.querySelector('[data-aw-toggle-color-scheme]');
    
    function logMenuColors() {
      const logData = {
        'üî¨ HEADER STATE': {
          hasScrollClass: header?.classList.contains('scroll'),
          isDarkMode: document.documentElement.classList.contains('dark'),
          scrollY: window.scrollY,
        },
        'üî¨ MENU LINK (first)': {
          computedColor: menuLinks[0] ? window.getComputedStyle(menuLinks[0]).color : null,
          classes: menuLinks[0]?.className,
        },
        'üî¨ TOGGLE ICON': {
          computedColor: toggleIcon ? window.getComputedStyle(toggleIcon).color : null,
          svgColor: toggleIcon?.querySelector('svg') ? window.getComputedStyle(toggleIcon.querySelector('svg')).color : null,
        },
      };
      
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üö® MENU COLOR DEBUG üö®');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      Object.entries(logData).forEach(([key, value]) => {
        console.log(key);
        console.table(value);
      });
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    }
    
    // Log initial state
    logMenuColors();
    
    // Log on scroll
    window.addEventListener('scroll', () => {
      setTimeout(logMenuColors, 100); // Wait for .scroll class to be added
    }, { passive: true });
  });
  // #endregion
</script>
