---
import Image from '~/components/common/Image.astro';
import Button from '~/components/ui/Button.astro';

import type { Hero as Props } from '~/types';

const {
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline,

  content = await Astro.slots.render('content'),
  actions = await Astro.slots.render('actions'),
  image = await Astro.slots.render('image'),
  mobileImage, // Optional: separates Mobile-Image

  id,
  bg = await Astro.slots.render('bg'),
} = Astro.props;

// #region agent log
fetch('http://127.0.0.1:7243/ingest/040cab7d-6d47-4d89-9978-7fcd3b1d787e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Hero.astro:20',message:'Hero Props received',data:{hasImage:!!image,hasMobileImage:!!mobileImage,mobileImageValue:mobileImage,imageValue:typeof image === 'object' ? image.src : 'string/slot',url:Astro.url.pathname},timestamp:Date.now(),sessionId:'debug-session',runId:'pre-fix',hypothesisId:'A,B,C'})}).catch(()=>{});
// #endregion
---

<section 
  class="relative md:-mt-[76px] not-prose min-h-[600px] md:min-h-[700px] flex items-center w-screen left-1/2 -translate-x-1/2 overflow-hidden" 
  {...id ? { id } : {}}
>
  <!-- Background Image mit Dark Overlay - Responsive (Separate Mobile/Desktop Bilder) -->
  {image && (
    <div class="absolute inset-0 w-full h-full z-0">
      {typeof image === 'string' ? (
        <Fragment set:html={image} />
      ) : (
        <>
          {/* Mobile Image: Verwende mobileImage falls vorhanden, sonst das normale image */}
          {mobileImage ? (
            <>
              {/* #region agent log */}
              <script>fetch('http://127.0.0.1:7243/ingest/040cab7d-6d47-4d89-9978-7fcd3b1d787e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Hero.astro:42',message:'Rendering SEPARATE mobile image',data:{mobileImage:'{mobileImage}',url:window.location.pathname},timestamp:Date.now(),sessionId:'debug-session',runId:'pre-fix',hypothesisId:'D'})}).catch(()=>{});</script>
              {/* #endregion */}
              
              <!-- Separates Mobile-Image (z.B. für Startseite) -->
              <img
                src={mobileImage}
                alt={image.alt || 'STOR Connect'}
                class="hero-image-mobile md:hidden w-full h-full object-cover object-center"
                loading="eager"
              />
            </>
          ) : (
            <>
              {/* #region agent log */}
              <script>fetch('http://127.0.0.1:7243/ingest/040cab7d-6d47-4d89-9978-7fcd3b1d787e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Hero.astro:58',message:'Using SAME image for mobile (no mobileImage prop)',data:{imageSrc:'{typeof image === "object" && image.src}',url:window.location.pathname},timestamp:Date.now(),sessionId:'debug-session',runId:'pre-fix',hypothesisId:'D'})}).catch(()=>{});</script>
              {/* #endregion */}
              
              <!-- Gleiches Bild für Mobile wie Desktop (für Unterseiten) -->
              <Image
                class="hero-image-mobile md:hidden w-full h-full object-cover object-center"
                widths={[640, 768, 1024]}
                sizes="100vw"
                loading="eager"
                format="webp"
                width={1024}
                height={768}
                {...image}
              />
            </>
          )}
          
          <!-- Desktop: Horizontal Hero Image (>= 768px) -->
          <Image
            class="hero-image-desktop hidden md:block w-full h-full object-cover object-center"
            widths={[640, 768, 1024, 1536, 1920, 2560]}
            sizes="100vw"
            loading="eager"
            format="webp"
            width={2560}
            height={1440}
            {...image}
          />
          
          <!-- Dark Overlay für Text-Lesbarkeit - VERSTÄRKT -->
          <div class="absolute inset-0 bg-gradient-to-b from-black/70 via-black/50 to-black/30"></div>
        </>
      )}
    </div>
  )}

  <!-- Fallback bg slot für custom backgrounds -->
  <div class="absolute inset-0 pointer-events-none z-0" aria-hidden="true">
    <slot name="bg">
      {bg ? <Fragment set:html={bg} /> : null}
    </slot>
  </div>

  <!-- Content (Text, Buttons) im Vordergrund -->
  <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 w-full">
    <div class="pt-0 md:pt-[76px] pointer-events-none"></div>
    <div class="py-16 md:py-20 lg:py-24">
      <div class="text-center pb-10 md:pb-16 max-w-5xl mx-auto">
        {
          tagline && (
            <p
              class="text-base text-white/80 dark:text-white/80 font-bold tracking-wide uppercase intersect-once intersect-quarter motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade"
              set:html={tagline}
            />
          )
        }
        {
          title && (
            <h1
              class="text-6xl md:text-7xl lg:text-8xl font-bold leading-tighter tracking-tighter mb-10 font-heading text-white dark:text-white intersect-once intersect-quarter motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade"
              set:html={title}
            />
          )
        }
        <div class="max-w-3xl mx-auto">
          {
            subtitle && (
              <p
                class="text-xl text-white/90 dark:text-white/90 mb-6 intersect-once intersect-quarter motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade"
                set:html={subtitle}
              />
            )
          }
          {
            actions && (
              <div class="max-w-xs sm:max-w-md m-auto flex flex-nowrap flex-col sm:flex-row sm:justify-center gap-4 intersect-once intersect-quarter motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade">
                {Array.isArray(actions) ? (
                  actions.map((action) => (
                    <div class="flex w-full sm:w-auto">
                      <Button {...(action || {})} class="w-full sm:mb-0" />
                    </div>
                  ))
                ) : (
                  <Fragment set:html={actions} />
                )}
              </div>
            )
          }
        </div>
        {content && <Fragment set:html={content} />}
      </div>
    </div>
  </div>
</section>

<style>
  /* Hero Background Image Optimierungen */
  section {
    position: relative;
    overflow: hidden;
  }

  /* Verhindere Layout Shift während Image lädt */
  @media (max-width: 767px) {
    section {
      min-height: 600px;
    }
  }

  @media (min-width: 768px) {
    section {
      min-height: 700px;
    }
  }

  /* Optimiere Image-Rendering - Separate Bilder für Mobile/Desktop */
  .hero-image-mobile,
  .hero-image-desktop,
  section img {
    min-width: 100% !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    object-position: center !important;
  }
</style>
