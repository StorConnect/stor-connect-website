---
// Cookie Consent - Eigenes Design mit Klaro nur f√ºr Logic
// KEIN Klaro CSS - komplett custom Implementation
---

<script is:inline>
  // Klaro Config - NUR f√ºr Consent-Management Logic
  window.klaroConfig = {
    version: 1,
    storageMethod: 'cookie',
    cookieName: 'stor-cookie-consent',
    cookieExpiresAfterDays: 365,
    
    // WICHTIG: Klaro's UI komplett deaktivieren
    noAutoLoad: true,           // Kein automatisches Banner
    embedded: true,             // Nur API nutzen
    
    default: false,
    mustConsent: true,
    
    services: [
      {
        name: 'necessary',
        purposes: ['essential'],
        required: true,
        default: true,
      },
      {
        name: 'analytics',
        purposes: ['analytics'],
        required: false,
        default: false,
      },
      {
        name: 'functional',
        purposes: ['functional'],
        required: false,
        default: false,
      }
    ]
  };
</script>

<script>
  // Klaro vom npm package importieren (nur Logic, kein UI)
  import * as Klaro from 'klaro';
  
  // Initialisiere Klaro ohne UI
  if (typeof window !== 'undefined') {
    Klaro.setup(window.klaroConfig);
  }
</script>

<!-- Custom STOR Connect Cookie Banner -->
<div id="stor-cookie-banner" class="stor-cookie-banner" style="display: none;">
  <div class="stor-cookie-backdrop"></div>
  
  <div class="stor-cookie-content">
    <div class="stor-cookie-header">
      <span class="stor-cookie-emoji">üç™</span>
      <h3 class="stor-cookie-title">Cookie-Einstellungen</h3>
    </div>
    
    <p class="stor-cookie-text">
      Wir nutzen Cookies auf unserer Website. Einige von ihnen sind essenziell, 
      w√§hrend andere uns helfen, diese Website und deine Erfahrung zu verbessern.
    </p>
    
    <div class="stor-cookie-links">
      <a href="/impressum" class="stor-cookie-link">Impressum</a>
      <a href="/datenschutz" class="stor-cookie-link">Datenschutz</a>
      <button id="stor-cookie-details" class="stor-cookie-link stor-cookie-link-btn">
        Cookie Richtlinien
      </button>
    </div>
    
    <div class="stor-cookie-buttons">
      <button id="stor-accept-all" class="stor-btn stor-btn-primary">
        Alle Cookies akzeptieren
      </button>
      <button id="stor-accept-necessary" class="stor-btn stor-btn-secondary">
        Nur notwendige
      </button>
    </div>
  </div>
  
  <!-- Details Modal (wenn "Cookie Richtlinien" geklickt) -->
  <div id="stor-cookie-details-modal" class="stor-cookie-modal" style="display: none;">
    <div class="stor-modal-content">
      <div class="stor-modal-header">
        <h3>Cookie-Einstellungen</h3>
        <button id="stor-modal-close" class="stor-modal-close">&times;</button>
      </div>
      
      <div class="stor-modal-body">
        <div class="stor-cookie-category">
          <details open>
            <summary class="stor-category-title">
              <span>Notwendige Cookies</span>
              <span class="stor-category-badge">Immer aktiv</span>
            </summary>
            <p class="stor-category-desc">
              Diese Cookies sind f√ºr die Grundfunktionen der Website erforderlich 
              und k√∂nnen nicht deaktiviert werden.
            </p>
          </details>
        </div>
        
        <div class="stor-cookie-category">
          <details>
            <summary class="stor-category-title">
              <span>Cookies f√ºr Marketing</span>
              <label class="stor-toggle">
                <input type="checkbox" id="stor-toggle-marketing" data-service="functional">
                <span class="stor-toggle-slider"></span>
              </label>
            </summary>
            <p class="stor-category-desc">
              Diese Cookies erm√∂glichen erweiterte Funktionalit√§t und Personalisierung.
            </p>
          </details>
        </div>
        
        <div class="stor-cookie-category">
          <details>
            <summary class="stor-category-title">
              <span>Cookies f√ºr Analyse</span>
              <label class="stor-toggle">
                <input type="checkbox" id="stor-toggle-analytics" data-service="analytics">
                <span class="stor-toggle-slider"></span>
              </label>
            </summary>
            <p class="stor-category-desc">
              Diese Cookies helfen uns zu verstehen, wie Besucher mit unserer Website interagieren.
            </p>
          </details>
        </div>
      </div>
      
      <div class="stor-modal-footer">
        <button id="stor-modal-save" class="stor-btn stor-btn-primary stor-btn-large">
          Auswahl speichern
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Custom Cookie Banner Logic mit Klaro API
  import * as Klaro from 'klaro';
  
  document.addEventListener('DOMContentLoaded', () => {
    const banner = document.getElementById('stor-cookie-banner');
    const detailsModal = document.getElementById('stor-cookie-details-modal');
    const acceptAllBtn = document.getElementById('stor-accept-all');
    const acceptNecessaryBtn = document.getElementById('stor-accept-necessary');
    const detailsBtn = document.getElementById('stor-cookie-details');
    const modalClose = document.getElementById('stor-modal-close');
    const modalSave = document.getElementById('stor-modal-save');
    
    // Klaro initialisieren (nur Logic, kein UI)
    const manager = Klaro.getManager(window.klaroConfig);
    
    // Banner anzeigen wenn noch keine Consent-Entscheidung
    const savedConsents = manager.consents;
    if (!savedConsents || Object.keys(savedConsents).length === 0) {
      banner.style.display = 'block';
    }
    
    // "Alle akzeptieren" Button
    acceptAllBtn.addEventListener('click', () => {
      manager.updateConsent('necessary', true);
      manager.updateConsent('analytics', true);
      manager.updateConsent('functional', true);
      manager.saveAndApplyConsents();
      banner.style.display = 'none';
    });
    
    // "Nur notwendige" Button
    acceptNecessaryBtn.addEventListener('click', () => {
      manager.updateConsent('necessary', true);
      manager.updateConsent('analytics', false);
      manager.updateConsent('functional', false);
      manager.saveAndApplyConsents();
      banner.style.display = 'none';
    });
    
    // "Cookie Richtlinien" - Details Modal √∂ffnen
    detailsBtn.addEventListener('click', () => {
      detailsModal.style.display = 'flex';
      
      // Toggle-States aus gespeicherten Consents laden
      const consents = manager.consents;
      document.getElementById('stor-toggle-analytics').checked = consents.analytics || false;
      document.getElementById('stor-toggle-marketing').checked = consents.functional || false;
    });
    
    // Modal schlie√üen
    modalClose.addEventListener('click', () => {
      detailsModal.style.display = 'none';
    });
    
    // "Auswahl speichern" im Modal
    modalSave.addEventListener('click', () => {
      const analyticsChecked = document.getElementById('stor-toggle-analytics').checked;
      const marketingChecked = document.getElementById('stor-toggle-marketing').checked;
      
      manager.updateConsent('necessary', true);
      manager.updateConsent('analytics', analyticsChecked);
      manager.updateConsent('functional', marketingChecked);
      manager.saveAndApplyConsents();
      
      detailsModal.style.display = 'none';
      banner.style.display = 'none';
    });
    
    // Modal Backdrop schlie√üt Modal
    detailsModal.addEventListener('click', (e) => {
      if (e.target === detailsModal) {
        detailsModal.style.display = 'none';
      }
    });
  });
</script>

<style is:global>
/* ========================================
   STOR CONNECT - CUSTOM COOKIE BANNER
   Eigenes Design ohne Klaro CSS
   ======================================== */

/* BACKDROP - Dezenter Overlay */
.stor-cookie-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.4);
  z-index: 9998;
}

/* BANNER CONTAINER */
.stor-cookie-banner {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9999;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  pointer-events: none;
}

.stor-cookie-banner * {
  pointer-events: auto;
}

/* COOKIE CONTENT BOX */
.stor-cookie-content {
  position: relative;
  background: white;
  border-radius: 0;
  padding: 1.5rem;
  width: 100%;
  max-width: 100%;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
  font-family: 'Inter Variable', system-ui, sans-serif;
  animation: slideUpBanner 0.3s ease-out;
}

/* DESKTOP: Zentrierte Box am Bottom */
@media (min-width: 768px) {
  .stor-cookie-content {
    max-width: 550px;
    border-radius: 12px;
    margin-bottom: 2rem;
    border: 1px solid #e5e7eb;
  }
}

@keyframes slideUpBanner {
  from {
    transform: translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* HEADER */
.stor-cookie-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.stor-cookie-emoji {
  font-size: 1.5rem;
  line-height: 1;
}

.stor-cookie-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #36454F;
  margin: 0;
}

/* TEXT */
.stor-cookie-text {
  font-size: 0.95rem;
  line-height: 1.6;
  color: #6b7280;
  margin: 0 0 1rem 0;
}

/* LINKS */
.stor-cookie-links {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  margin-bottom: 1.25rem;
  font-size: 0.9rem;
}

.stor-cookie-link {
  color: #36454F;
  text-decoration: underline;
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
  font-size: inherit;
  font-family: inherit;
}

.stor-cookie-link:hover {
  color: #E01D22;
}

/* BUTTONS */
.stor-cookie-buttons {
  display: flex;
  gap: 0.75rem;
  flex-direction: column;
}

@media (min-width: 768px) {
  .stor-cookie-buttons {
    flex-direction: row;
  }
}

.stor-btn {
  padding: 0.875rem 1.5rem;
  border-radius: 8px;
  font-size: 0.95rem;
  font-weight: 500;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: inherit;
  flex: 1;
  min-width: 0;
}

@media (max-width: 767px) {
  .stor-btn {
    width: 100%;
  }
}

.stor-btn-primary {
  background-color: #E01D22;
  color: white;
}

.stor-btn-primary:hover {
  background-color: #C9302C;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(224, 29, 34, 0.3);
}

.stor-btn-secondary {
  background-color: #f3f4f6;
  color: #36454F;
  border: 1px solid #e5e7eb;
}

.stor-btn-secondary:hover {
  background-color: #e5e7eb;
}

/* DETAILS MODAL */
.stor-cookie-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 1rem;
}

.stor-modal-content {
  background: white;
  border-radius: 12px;
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalFadeIn 0.2s ease-out;
}

@keyframes modalFadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.stor-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
}

.stor-modal-header h3 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #36454F;
}

.stor-modal-close {
  background: none;
  border: none;
  font-size: 2rem;
  line-height: 1;
  color: #6b7280;
  cursor: pointer;
  padding: 0;
  width: 2rem;
  height: 2rem;
}

.stor-modal-close:hover {
  color: #36454F;
}

.stor-modal-body {
  padding: 1.5rem;
}

.stor-cookie-category {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  margin-bottom: 0.75rem;
  background: #fafafa;
}

.stor-cookie-category details {
  padding: 0;
}

.stor-cookie-category summary {
  list-style: none;
  cursor: pointer;
}

.stor-cookie-category summary::-webkit-details-marker {
  display: none;
}

.stor-category-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  font-weight: 600;
  color: #36454F;
}

.stor-category-badge {
  font-size: 0.85rem;
  font-weight: 500;
  color: #6b7280;
  background: #e5e7eb;
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
}

.stor-category-desc {
  padding: 0 1rem 1rem 1rem;
  margin: 0;
  font-size: 0.9rem;
  color: #6b7280;
  line-height: 1.5;
}

/* TOGGLE SWITCH */
.stor-toggle {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 24px;
  cursor: pointer;
}

.stor-toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}

.stor-toggle-slider {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #d1d5db;
  border-radius: 24px;
  transition: 0.3s;
}

.stor-toggle-slider:before {
  content: "";
  position: absolute;
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  border-radius: 50%;
  transition: 0.3s;
}

.stor-toggle input:checked + .stor-toggle-slider {
  background-color: #E01D22;
}

.stor-toggle input:checked + .stor-toggle-slider:before {
  transform: translateX(24px);
}

.stor-modal-footer {
  padding: 1.5rem;
  border-top: 1px solid #e5e7eb;
}

.stor-btn-large {
  width: 100%;
  padding: 1rem;
  font-size: 1rem;
}

/* MOBILE OPTIMIERUNGEN */
@media (max-width: 767px) {
  .stor-cookie-content {
    padding: 1.25rem;
    border-radius: 0;
  }
  
  .stor-cookie-title {
    font-size: 1.1rem;
  }
  
  .stor-cookie-text {
    font-size: 0.9rem;
  }
  
  .stor-modal-content {
    border-radius: 12px 12px 0 0;
    max-height: 85vh;
  }
}

/* PRINT */
@media print {
  .stor-cookie-banner,
  .stor-cookie-modal {
    display: none !important;
  }
}
</style>
